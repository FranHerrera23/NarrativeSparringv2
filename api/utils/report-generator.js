/**
 * REPORT GENERATOR MODULE
 * Narrative Sparring - Convert markdown reports to PDF
 *
 * Converts Claude-generated markdown to branded PDF documents
 */

const markdownPdf = require('markdown-pdf');
const { Readable } = require('stream');

/**
 * Convert markdown report to PDF
 * @param {string} markdown - The markdown content from Claude
 * @param {Object} options - Generation options
 * @returns {Promise<Buffer>} - PDF buffer
 */
async function generatePDF(markdown, options = {}) {
  const {
    title = 'Narrative Sparring Report',
    author = 'CRUDA',
  } = options;

  return new Promise((resolve, reject) => {
    try {
      // Create a readable stream from markdown string
      const markdownStream = Readable.from([markdown]);

      // Buffer to collect PDF chunks
      const chunks = [];

      // Configure markdown-pdf with custom styling
      const pdfOptions = {
        cssPath: null, // We'll use inline CSS
        remarkable: {
          html: true,
          breaks: true,
        },
        paperFormat: 'Letter',
        paperOrientation: 'portrait',
        paperBorder: '2cm',
        renderDelay: 100,
        preProcessMd: (md) => addBranding(md, title),
      };

      // Generate PDF
      markdownStream
        .pipe(markdownPdf(pdfOptions))
        .on('data', (chunk) => chunks.push(chunk))
        .on('end', () => {
          const pdfBuffer = Buffer.concat(chunks);
          resolve(pdfBuffer);
        })
        .on('error', (error) => {
          reject(new Error(`PDF generation failed: ${error.message}`));
        });

    } catch (error) {
      reject(new Error(`PDF setup failed: ${error.message}`));
    }
  });
}

/**
 * Add CRUDA branding to markdown
 */
function addBranding(markdown, title) {
  const header = `---

# ${title}

**Diagnostic by CRUDA | Narrative Sparring**

---

`;

  const footer = `

---

*This report was generated by CRUDA's narrative diagnostic engine.*
*Questions? Contact us at support@cruda.io*

---
`;

  return header + markdown + footer;
}

/**
 * Simpler alternative: Generate HTML instead of PDF
 * (In case markdown-pdf has issues, we can use this as fallback)
 */
function generateHTML(markdown, options = {}) {
  const {
    title = 'Narrative Sparring Report',
  } = options;

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
      color: #333;
    }
    h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #000;
    }
    h2 {
      font-size: 24px;
      font-weight: 600;
      margin-top: 40px;
      margin-bottom: 15px;
      color: #000;
      border-bottom: 2px solid #000;
      padding-bottom: 5px;
    }
    h3 {
      font-size: 18px;
      font-weight: 600;
      margin-top: 30px;
      margin-bottom: 10px;
      color: #222;
    }
    p {
      margin-bottom: 15px;
    }
    ul, ol {
      margin-bottom: 15px;
      padding-left: 30px;
    }
    li {
      margin-bottom: 8px;
    }
    blockquote {
      border-left: 4px solid #ddd;
      padding-left: 20px;
      margin-left: 0;
      color: #666;
      font-style: italic;
    }
    .header {
      text-align: center;
      border-bottom: 3px solid #000;
      padding-bottom: 20px;
      margin-bottom: 40px;
    }
    .footer {
      text-align: center;
      border-top: 2px solid #ddd;
      padding-top: 20px;
      margin-top: 60px;
      color: #666;
      font-size: 14px;
    }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
    pre {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>${title}</h1>
    <p><strong>Diagnostic by CRUDA | Narrative Sparring</strong></p>
  </div>

  ${convertMarkdownToHTML(markdown)}

  <div class="footer">
    <p><em>This report was generated by CRUDA's narrative diagnostic engine.</em></p>
    <p>Questions? Contact us at support@cruda.io</p>
  </div>
</body>
</html>`;

  return html;
}

/**
 * Basic markdown to HTML converter
 * (Simple implementation for fallback)
 */
function convertMarkdownToHTML(markdown) {
  let html = markdown;

  // Headers
  html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
  html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
  html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

  // Bold
  html = html.replace(/\*\*(.*?)\*\*/gms, '<strong>$1</strong>');

  // Italic
  html = html.replace(/\*([^*\n]+)\*/g, '<em>$1</em>');

  // Links
  html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>');

  // Paragraphs
  html = html.replace(/\n\n/g, '</p><p>');
  html = '<p>' + html + '</p>';

  // Clean up empty paragraphs
  html = html.replace(/<p><\/p>/g, '');
  html = html.replace(/<p>\s*<\/p>/g, '');

  return html;
}

module.exports = {
  generatePDF,
  generateHTML,
};
